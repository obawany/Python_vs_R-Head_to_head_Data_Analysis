define(["require","exports","tslib","external/react","modules/clean/previews/util","modules/clean/react/pass/empty_seen_state_facepile","modules/clean/react/pass/seen_state_facepile","modules/clean/react/file_viewer/utils","modules/clean/react/pass/constants","modules/clean/react/pass/data_helpers","modules/clean/react/pass/store","modules/clean/react/pass/types","modules/clean/sharing/stores/sharing_info","modules/core/i18n"],function(e,s,t,n,o,r,i,a,p,u,l,f,c,h){"use strict";Object.defineProperty(s,"__esModule",{value:!0});var d=(function(e){function s(s){var t=e.call(this,s)||this;return t.state=t.getStateFromStore(),t.boundUpdate=t.onUpdateFromStore.bind(t),t}return t.__extends(s,e),s.prototype.componentWillMount=function(){l.passStore.add_change_listener(this.boundUpdate),c.sharingInfoStore.add_change_listener(this.boundUpdate);var e=!!o.isPassPerfExperiment()&&this.props.isViewMetadataDisabled;u.PassHelpers.setup({user:this.props.user,fileData:this.getPassFileData(),skipSharingEndpoints:e,prevFileData:null,shouldWritePresence:this.shouldRegisterPresence()})},s.prototype.componentWillReceiveProps=function(e){a.areFilesEqual(e.file,this.props.file)||this.setState({passInfo:{anonymousPresence:null,isPassPermissionsPending:!0,passFetchingStatus:p.PASS_FETCHING_STATUS.FETCHING,passPermissions:null,presence:null,identifiedSeenStateInfo:null,userIdsWithoutSeenStateInfo:[]},sharingInfo:void 0})},s.prototype.componentWillUpdate=function(e,s){var t=s.passInfo;if(t.userIdsWithoutSeenStateInfo.length>0&&p.fetchingStatusIsSuccessful(t.passFetchingStatus)&&e.user){var n=e.file;u.SeenStateHelpers.fetchSeenStateUsers(e.user.id,t.identifiedSeenStateInfo,t.userIdsWithoutSeenStateInfo,n.ns_id,n.sjid,n.file_id)}},s.prototype.componentDidUpdate=function(e){if(!a.areFilesEqual(this.props.file,e.file)){var s={file:e.file,url:this.urlFromProps(e)},t=!!o.isPassPerfExperiment()&&this.props.isViewMetadataDisabled;u.PassHelpers.setup({user:this.props.user,fileData:this.getPassFileData(),skipSharingEndpoints:t,prevFileData:s,shouldWritePresence:this.shouldRegisterPresence()})}},s.prototype.componentWillUnmount=function(){l.passStore.remove_change_listener(this.boundUpdate),c.sharingInfoStore.remove_change_listener(this.boundUpdate),u.PassHelpers.teardown({user:this.props.user,fileData:this.getPassFileData(),async:this.shouldRegisterPresence()})},s.prototype.onUpdateFromStore=function(){this.setState(this.getStateFromStore())},s.prototype.getStateFromStore=function(){var e=this.props,s=e.user,t=e.file,n=t.file_id,o=t.ns_id,r=t.sjid;return{passInfo:{anonymousPresence:l.passStore.anonymousPresence(o,r),isPassPermissionsPending:l.passStore.isPassPermissionsPending(n),passFetchingStatus:l.passStore.passFetchingStatus(o,r),passPermissions:l.passStore.getPassPermissions(n),presence:l.passStore.presence(this.props.file.ns_id,this.props.file.sjid),identifiedSeenStateInfo:l.passStore.identifiedSeenStateInfo(o,r),userIdsWithoutSeenStateInfo:l.passStore.userIdsWithoutSeenStateInfo(o,r)},sharingInfo:s&&c.sharingInfoStore.getSharingInfo(s.id,n)||void 0}},s.prototype.getAnonymousPassInfo=function(){return null==this.state.passInfo.anonymousPresence?[]:this.state.passInfo.anonymousPresence.map(function(e){return{seen_state_user:{user_id:e,display_name:h._("Guest")},seen_events:[]}})},s.prototype.getMemberInfosInPassFormat=function(e){return{invitees:this.getInviteeMemberInfos(e),users:this.getUserMemberInfos(e)}},s.prototype.getUserMemberInfos=function(e){return e.members().get("users").valueSeq().toArray().map(function(e){return{seen_state_user:{user_id:e.account_id,display_name:e.account?e.account.display_name:null,photo_url:e.account?e.account.profile_photo_url:null,access_level:e.access_type},seen_events:[]}})},s.prototype.getInviteeMemberInfos=function(e){return e.members().get("invitees").valueSeq().toArray().map(function(e){return{seen_state_user:{display_name:e.contact,access_level:e.access_type},seen_events:[]}})},s.prototype.getPassFileData=function(){return{file:this.props.file,url:this.urlFromProps()}},s.prototype.shouldRegisterPresence=function(){return!this.props.fromBrowse},s.prototype.urlFromProps=function(e){return void 0===e&&(e=this.props),e.sharedLinkInfo?e.sharedLinkInfo.url:void 0},s.prototype.getPropsFromPassInfo=function(){return{anonymousPresenceInfo:this.getAnonymousPassInfo(),isPassPermissionsPending:this.state.passInfo.isPassPermissionsPending,passFetchingStatus:this.state.passInfo.passFetchingStatus,passPermissions:this.state.passInfo.passPermissions,presence:this.state.passInfo.presence,identifiedSeenStateInfo:this.state.passInfo.identifiedSeenStateInfo}},s.prototype.getPropsFromSharingInfo=function(){var e={uniqueMemberCountInfo:f.FacepileInfo.createNotLoaded(),sharingStorePassInfo:f.FacepileInfo.createNotLoaded()};return this.state.sharingInfo?(null!=this.state.sharingInfo.memberCounts()&&(e.uniqueMemberCountInfo=f.FacepileInfo.create(this.state.sharingInfo.memberCounts().total_unique_users)),this.state.sharingInfo.hasDisplayableMembers()&&(e.sharingStorePassInfo=f.FacepileInfo.create(this.getMemberInfosInPassFormat(this.state.sharingInfo))),e):e},s.prototype.getPropsFromController=function(){var e=this.props,s=e.file,t=e.fromBrowse,n=e.sizeClass,o=e.user;return{file:s,fromBrowse:t,sizeClass:n,url:this.urlFromProps(),user:o}},s.prototype.render=function(){if(null==this.props.user)return n.createElement(r.EmptySeenStateFacepile,null);var e=t.__assign({},this.getPropsFromPassInfo(),this.getPropsFromSharingInfo(),this.getPropsFromController());return n.createElement(i.SeenStateFacepile,t.__assign({},e))},s.displayName="SeenStateFacepileController",s})(n.Component);s.SeenStateFacepileController=d});
//# sourceMappingURL=seen_state_facepile_controller.min.js-vfl_JnrC1.map