define(["require","exports","external/classnames","external/create-react-class","external/react","modules/clean/comments/annotation_utils","modules/clean/comments/components/ui_constants","modules/clean/react/file_comments/conversation_or_input_card","modules/clean/react/sprite","modules/constants/comments_panel","modules/core/i18n"],function(t,n,e,o,i,s,r,a,u,p,l){"use strict";function m(t,n){return void 0!==t&&null!==t?n(t):void 0}var c=i.DOM;return o({displayName:"AnnotationBubble",mixins:[i.addons.PureRenderMixin],propTypes:{user:i.PropTypes.object,activity:i.PropTypes.object,x:i.PropTypes.number,y:i.PropTypes.number,showBubble:i.PropTypes.bool,in_blank_state:i.PropTypes.bool,annotation:i.PropTypes.object,position:i.PropTypes.string,maxHeight:i.PropTypes.number,shouldShowExpandBubble:i.PropTypes.bool,isMouseOnAnnotation:i.PropTypes.bool,commentText:i.PropTypes.string,actionCreators:i.PropTypes.object.isRequired,isDemoMode:i.PropTypes.bool},getInitialState:function(){return{showExpandBubble:this.props.shouldShowExpandBubble}},getDefaultProps:function(){return{position:"top",maxHeight:r.DEFAULT_ANNOTATION_COMMENT_INPUT_MAX_HEIGHT,isDemoMode:!1}},componentWillReceiveProps:function(t){if(this.props.shouldShowExpandBubble)if(t.commentText||this.props.showBubble!==!1||t.showBubble!==!0||this.setState({showExpandBubble:!0}),this.props.isMouseOnAnnotation){if(!t.isMouseOnAnnotation)return this._onAnnotationExpandBubbleMouseLeave()}else if(t.isMouseOnAnnotation)return this._onAnnotationExpandBubbleMouseEnter()},componentWillUnmount:function(){return clearTimeout(this.hideBubbleTimeout)},onInputFocus:function(t){return{}},onInputBlur:function(t){return{}},onMention:function(){return this.props.actionCreators.setMentionedContact(!0)},onAddComment:function(t){return this.props.actionCreators.addInlineAnnotation({text:t})},onAddSticker:function(t){return this.props.actionCreators.addInlineAnnotation({stickerId:t})},onCancelComment:function(){return this.props.actionCreators.cancelAnnotationComment()},_getCommentInputRef:function(){return null!=this.refs.commentInputCard?this.refs.commentInputCard.refs.commentInput:void 0},_focusOnCommentInput:function(){return m(this._getCommentInputRef(),function(t){return t.focusInput()})},_getRawCommentInput:function(){return m(this._getCommentInputRef(),function(t){return t.getRawCommentInput()})||""},_saveDraft:function(){var t=this._getRawCommentInput();return t.length>0&&t!==m(this._getCommentInputRef(),function(t){return t.getPlaceholderText()})?this.props.actionCreators.updateAnnotationText(t):this.props.actionCreators.updateAnnotationText(null)},_onAnnotationExpandBubbleClick:function(){return this.setState({showExpandBubble:!1})},_onAnnotationExpandBubbleMouseEnter:function(){return clearTimeout(this.hideBubbleTimeout)},_onAnnotationExpandBubbleMouseLeave:function(){return this._setHideCommentTimeOut()},_setHideCommentTimeOut:function(){return clearTimeout(this.hideBubbleTimeout),this.hideBubbleTimeout=setTimeout(this._maybeHideComment,3e3)},_maybeHideComment:function(){if(this.state.showExpandBubble&&!this.props.isMouseOnAnnotation)return this.onCancelComment()},_renderCommentInput:function(){var t={maxHeight:this.props.maxHeight},n={ref:"commentInput",activity:this.props.activity,metadata:this.props.annotation,usersToNotify:this.props.activity.users_to_notify,targetActivity:this.props.activity,user:this.props.user,initialText:this.props.commentText,enableNoNotifyHint:!1,commentMetadataAllowed:!0,shouldPopupsDropdown:!1,shouldAlwaysInEditMode:!0,shouldEnableCancelButton:!1,shouldInitiallyFocusInput:!0,shouldEnableStickers:p.ALLOW_STICKERS,shouldShowPostText:!0,onAddComment:this.onAddComment,onAddSticker:this.onAddSticker,onCancelComment:this.onCancelComment,onFocus:this.onInputFocus,onBlur:this.onInputBlur,onMention:this.onMention,onChange:this._saveDraft};return c.div({className:"annotation-bubble__field",style:t},i.createElement(a.InputCard,{ref:"commentInputCard",shouldInitiallyShowNotifyHint:this.props.shouldShowExpandBubble,initialUsersToNotify:null!=this.props.activity?this.props.activity.users_to_notify:void 0,commentProps:n,actionCreators:this.props.actionCreators,isDemoMode:this.props.isDemoMode}))},_renderExpandBubble:function(){return c.div({className:"expand-bubble-icon",onClick:this._onAnnotationExpandBubbleClick,onMouseEnter:this._onAnnotationExpandBubbleMouseEnter,onMouseLeave:this._onAnnotationExpandBubbleMouseLeave},i.createElement(u,{group:"web",name:"ic_comment_text",alt:l._("Comment on text")}))},render:function(){var t,n=this.props.x||0,o=this.props.y||0,i=this.props.position;if(t=this.props.position.indexOf("bottom")>=0?"bottom":"top",this.state.showExpandBubble){var r=Array.from(s.getExpandBubblePosition(this.props.position,this.props.x,this.props.y)),a=r[0],u=r[1];n=u.x,o=u.y,i=a}var p=(l={left:n},l[t]=o,l);return c.div({className:"annotation-bubble-container"},c.div({className:e((m={"annotation-bubble":!0,"annotation-bubble--hidden":!this.props.showBubble,"bubble-dropdown":!0,"expand-bubble":this.state.showExpandBubble},m[i]=!0,m)),style:p},this.state.showExpandBubble?this._renderExpandBubble():this._renderCommentInput(),c.div({className:"bubble-arrow-border"}),c.div({className:"bubble-arrow"})));var l,m}})});
//# sourceMappingURL=annotation_bubble.min.js-vfl06_tY0.map