define(["require","exports","tslib","external/keymaster","external/react","external/classnames","jquery","modules/clean/analytics","modules/clean/keycode","modules/clean/react/css_timing","modules/clean/react/file_viewer/actions","modules/clean/previews/util","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/full_screen_helpers","modules/clean/react/file_viewer/sidebar_helpers","modules/clean/react/keyboard_binding/keyboard_binding_connector","modules/clean/react/previews/frame_messenger_host","modules/clean/react/size_class/constants","modules/clean/react/sprite","modules/clean/static_urls","modules/core/dom","modules/core/exception","modules/core/i18n"],function(e,t,o,n,s,r,i,a,l,p,c,u,d,m,y,h,g,f,_,C,b,T,E){"use strict";function w(e){var t=e.className,o=e.disabled,n=e.iconName,i=e.onClick,a=e.spriteGroup,l=e.spriteName,p=e.tooltip;return s.createElement("div",{className:r(t,"toolbar-button-entry"),onMouseUp:i},s.createElement("div",{className:"toolbar-tooltip"},s.createElement("div",{className:"toolbar-tooltip-container"},s.createElement("div",{className:"toolbar-tooltip-pointer-border"})),s.createElement("div",{className:"toolbar-tooltip-container"},s.createElement("div",{className:"toolbar-tooltip-body"},p)),s.createElement("div",{className:"toolbar-tooltip-container"},s.createElement("div",{className:"toolbar-tooltip-pointer"}))),s.createElement("button",{alt:p},void 0!==n?s.createElement("img",{src:C.static_url("/static/images/previews/toolbar/"+n+".svg"),alt:p,className:r({disabled:o})}):s.createElement(_,{group:a,name:l,alt:p,className:r({disabled:o})})))}function K(e){var t=e.currentPage,o=e.docType,n=e.pagesCount,r=e.sizeClass;if(!t||!n)return null;var i="";i=r===f.SizeClass.Small?E._("%(current_page)s of %(pages_count)s"):o===d.DocType.spp?E._("Slide %(current_page)s of %(pages_count)s"):E._("Page %(current_page)s of %(pages_count)s");var a=i.format({current_page:t,pages_count:n});return s.createElement("div",{className:v.PAGE_INDICATOR},a)}Object.defineProperty(t,"__esModule",{value:!0});var O={};O[l.KeyCode.ESC]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.SPACE]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.PAGE_UP]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.PAGE_DOWN]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.LEFT]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.UP]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.RIGHT]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.DOWN]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.EQUALS]={altKey:!0,ctrlKey:!0,metaKey:!0},O[70]={altKey:!1,ctrlKey:!0,metaKey:!0},O[80]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.PLUS_EQUALS_FF]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.MINUS_FF]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.PLUS_EQUALS_FF_GERMAN]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.MINUS_FF_MAC]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.PLUS_CHROME]={altKey:!0,ctrlKey:!0,metaKey:!0},O[l.KeyCode.MINUS_CHROME]={altKey:!0,ctrlKey:!0,metaKey:!0};var v={ENABLE_REGION_CREATION:"enable-region-creation",FULLSCREEN:"fullscreen",PAGE_DOWN:"page-down",PAGE_INDICATOR:"page-indicator",PAGE_UP:"page-up",PRINT:"print",SIDEBAR:"sidebar",ZOOM_IN:"zoom-in",ZOOM_OUT:"zoom-out"},N={default:["page-indicator","zoom-in","zoom-out","page-up","page-down","fullscreen","print","enable-region-creation"],spp:["sidebar","page-indicator","page-up","page-down","fullscreen","print","enable-region-creation"],spreadsheet:["zoom-in","zoom-out","fullscreen","print"],html:["fullscreen","print"]},P={default:["page-indicator"],spp:["page-indicator"],spreadsheet:[],html:[]},S={ZOOM_IN:"zoom-in",ZOOM_OUT:"zoom-out",PAGE_UP:"page-up",PAGE_DOWN:"page-down",ENTER_FULLSCREEN:"enter-fullscreen",EXIT_VIEWER_FULLSCREEN:"exit-viewer-fullscreen",PRINT:"print",CLEAR_MOUSE_TRACKING:"clear-mouse-tracking",SCROLL_DOWN:"scroll-down",SCROLL_UP:"scroll-up",SCROLL_LEFT:"scroll-left",SCROLL_RIGHT:"scroll-right",SCREEN_DOWN:"screen-down",SCREEN_UP:"screen-up",ENABLE_REGION_CREATION:"enable-region-creation",PREVIEW_TOOLBAR_MOUNTED:"preview-toolbar-mounted"};t.PreviewToolbarButton=w;var M=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.handleClick=function(){var e=t.props,o=e.isSidebarOpen,n=e.onClick,s=e.onSidebarClose,r=e.onSidebarOpen;o&&s?s():r&&r(),n&&n()},t}return o.__extends(t,e),t.prototype.render=function(){var e=this.props,t=e.disabled,o=e.isSidebarOpen;return s.createElement(w,{className:v.SIDEBAR,disabled:t,iconName:o?"sidebar_hide":"sidebar_show",tooltip:o?E._("Hide sidebar"):E._("Show sidebar"),onClick:this.handleClick})},t})(s.PureComponent),A=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.previewOpen=!1,t.state={currentPage:1,visible:!1,fadingOut:!1,disabledButtons:{}},t.handleMessageFromChild=function(e){var o={input_method:"child-message",file_ext:t.props.fileExtension},n={context:d.UserActionContext.Unknown};switch(e.action){case"page-change":var s=e.parameters,r=t.isToolbarReadyToShow(),i=t.sanitizePageNumber(s.current_page),l=t.sanitizePageNumber(t.props.pagesCount||s.pages_count);if(i<=0||l<=0)break;var p={pageUp:i<=1,pageDown:i>=l,print:!t.canPrint()};t.setState({currentPage:i,disabledButtons:p},function(){!r&&t.isToolbarReadyToShow()&&(t.fadeIn(),t.startIdleTimeout())});break;case"idle-mouse":t.state.hovering||t.fadeOut(),a.PreviewActivityLogger.log("idle-mouse",o);break;case"active-mouse":t.fadeIn();break;case"exit-parent-fullscreen":t.setFullScreen(!1,n);break;case"keydown":t.onKeydown(e.parameters);break;case"get-keydown-keys-handled-by-parent":t.postKeysHandledByParent()}},t.onSidebarClose=function(){"function"==typeof t.props.onSidebarClose&&t.props.onSidebarClose(d.UserActionContext.Toolbar)},t.onSidebarOpen=function(){"function"==typeof t.props.onSidebarOpen&&t.props.onSidebarOpen(d.UserActionContext.Toolbar)},t.onMouseEnterToolbar=function(){t.frameMessenger.postMessageToChildren(S.CLEAR_MOUSE_TRACKING),t.setState({hovering:!0}),t.clearIdleTimeout()},t.onMouseLeaveToolbar=function(){t.setState({hovering:!1})},t.onKeydown=function(e){var o=!1;if(t.frameMessenger.childIsValidated()&&"dbmodal"!==n.getScope()&&!b.focus_in_input()&&!b.is_input(e.target)){if(null!=e.target){var s=i("#file-comments");if(1!==s.length&&(s=i("#photo-comments")),1===s.length&&(e.target===s[0]||i.contains(s[0],e.currentTarget)))return}var r={input_method:"keydown",file_ext:t.props.fileExtension,extra:JSON.stringify({keycode:e.keyCode})},a={context:d.UserActionContext.Keyboard},p=e.keyCode;return t.props.docType!==d.DocType.spp&&[l.KeyCode.EQUALS,l.KeyCode.PLUS_EQUALS_FF,l.KeyCode.PLUS_CHROME,l.KeyCode.PLUS_EQUALS_FF_GERMAN].indexOf(p)>-1?(t.zoomIn(a),o=!0):t.props.docType!==d.DocType.spp&&[l.KeyCode.MINUS_FF_MAC,l.KeyCode.MINUS_FF,l.KeyCode.MINUS_CHROME].indexOf(p)>-1?(t.zoomOut(a),o=!0):p===l.KeyCode.LEFT?(t.scrollLeft(r),o=!0):p===l.KeyCode.RIGHT?(t.scrollRight(r),o=!0):p===l.KeyCode.PAGE_UP?(t.props.docType===d.DocType.spp?t.pageUp(r):t.screenUp(r),o=!0):[l.KeyCode.SPACE,l.KeyCode.PAGE_DOWN].indexOf(p)>-1?(t.props.docType===d.DocType.spp?t.pageDown(r):t.screenDown(r),o=!0):p===l.KeyCode.UP?(t.props.docType===d.DocType.spp?t.pageUp(r):t.scrollUp(r),o=!0):p===l.KeyCode.DOWN?(t.props.docType===d.DocType.spp?t.pageDown(r):t.scrollDown(r),o=!0):70!==p||e.ctrlKey||e.metaKey?70===p&&(e.ctrlKey||e.metaKey)?t.searchInline(a):80===p?(t.printDocument(a),o=!0):p===l.KeyCode.ESC&&(t.isViewerFullscreen()?t.exitFullscreen(a):t.props.afterFileViewerExit&&!t.isAnnotationBubbleShown()&&t.exitPreview(r),o=!0):(t.isViewerFullscreen()?t.exitFullscreen(a):t.enterFullscreen(a),o=!0),o&&null!=e.preventDefault&&e.preventDefault(),!o}},t.pageUp=function(e){t.logAndPostMessage(S.PAGE_UP,"page-up",e)},t.pageDown=function(e){t.logAndPostMessage(S.PAGE_DOWN,"page-down",e)},t.screenUp=function(e){t.logAndPostMessage(S.SCREEN_UP,"screen-up",e)},t.screenDown=function(e){t.logAndPostMessage(S.SCREEN_DOWN,"screen-down",e)},t.scrollUp=function(e){t.logAndPostMessage(S.SCROLL_UP,"scroll-up",e)},t.scrollDown=function(e){t.logAndPostMessage(S.SCROLL_DOWN,"scroll-down",e)},t.scrollRight=function(e){t.logAndPostMessage(S.SCROLL_RIGHT,"scroll-right",e)},t.scrollLeft=function(e){t.logAndPostMessage(S.SCROLL_LEFT,"scroll-left",e)},t}return o.__extends(t,e),t.prototype.reset=function(){this.clearAllTimeouts(),this.setState({currentPage:0,visible:!1,fadingOut:!1,disabledButtons:{}})},t.prototype.setFullScreen=function(e,t){e?m.enterFullScreen(!0,t.context):m.exitFullScreen(t.context)},t.prototype.isViewerFullscreen=function(){return this.props.isFullscreen||m.isBrowserFullscreen()},t.prototype.postKeysHandledByParent=function(){this.frameMessenger.postMessageToChildren("keydown-keys-handled-by-parent",{keycodes:O})},t.prototype.onPreviewOpen=function(){return!!this.previewOpen||(i(document).on("keydown",this.onKeydown),this.previewOpen=!0,!0)},t.prototype.onPreviewClose=function(){return!this.previewOpen||(i(document).off("keydown",this.onKeydown),this.reset(),this.frameMessenger.resetOriginsForPosting(),this.previewOpen=!1,!0)},t.prototype.componentDidMount=function(){this.props.frameMessenger?this.frameMessenger=this.props.frameMessenger:this.frameMessenger=new g.PreviewFrameMessengerHost,this.frameMessenger.configureChildMessaging(u.getIframeQuery(),this.handleMessageFromChild,["page-change","idle-mouse","active-mouse","exit-parent-fullscreen","keydown","child-focus","get-keydown-keys-handled-by-parent"]),this.frameMessenger.startListening(),this.postKeysHandledByParent(),this.onPreviewOpen(),this.frameMessenger.postMessageToChildren(S.PREVIEW_TOOLBAR_MOUNTED),this.fadeIn(),this.startIdleTimeout()},t.prototype.componentWillUnmount=function(){this.clearAllTimeouts(),this.onPreviewClose(),this.frameMessenger.stopListening()},t.prototype.canPrint=function(){return!(this.props.sharePermissions&&this.props.sharePermissions.canPrintRoles&&0===this.props.sharePermissions.canPrintRoles.length)},t.prototype.showButton=function(e){return this.props.sizeClass===f.SizeClass.Small?P[this.props.docType].includes(e):N[this.props.docType].includes(e)},t.prototype.render=function(){var e,t=this,n=this.props,r=n.isFullscreen,i=n.sizeClass,a="preview-toolbar-overlay-container ";this.state.visible&&!this.props.isHidden||(a+="hide "),this.state.fadingOut&&(a+="fadeout ");var l={className:a},p=this.props.docType===d.DocType.spp?E._("Previous slide"):E._("Page up"),c=this.props.docType===d.DocType.spp?E._("Next slide"):E._("Page down");e=this.canPrint()?E._("Print"):E._("Printing is turned off for this file.");var u={input_method:"click",file_ext:this.props.fileExtension},m={context:d.UserActionContext.Toolbar},g=function(e){return function(){e(),t.frameMessenger.postMessageToChildren(S.CLEAR_MOUSE_TRACKING)}};return s.createElement("div",o.__assign({},l),s.createElement(h.KeyboardBindingConnector,{allKeyCallback:this.onKeydown}),s.createElement("div",{className:"preview-toolbar-overlay",onMouseEnter:this.onMouseEnterToolbar,onMouseLeave:this.onMouseLeaveToolbar},s.createElement("div",{className:"preview-toolbar-content"},this.showButton("sidebar")&&y.isSidebarEnabled(i,r)?s.createElement(M,{isSidebarOpen:this.props.isSidebarOpen,onSidebarClose:this.onSidebarClose,onSidebarOpen:this.onSidebarOpen}):null,this.showButton("page-indicator")?s.createElement(K,{currentPage:this.state.currentPage,docType:this.props.docType,pagesCount:this.props.pagesCount,sizeClass:this.props.sizeClass}):null,this.showButton("zoom-out")?s.createElement(w,{className:v.ZOOM_OUT,spriteGroup:"web",spriteName:"zoomout",tooltip:E._("Zoom out"),onClick:g(function(){return t.zoomOut(m)})}):null,this.showButton("zoom-in")?s.createElement(w,{className:v.ZOOM_IN,spriteGroup:"web",spriteName:"zoom",tooltip:E._("Zoom in"),onClick:g(function(){return t.zoomIn(m)})}):null,this.showButton("page-up")?s.createElement(w,{disabled:this.state.disabledButtons.pageUp,className:v.PAGE_UP,spriteGroup:"web",spriteName:"up",tooltip:p,onClick:g(function(){return t.pageUp(u)})}):null,this.showButton("page-down")?s.createElement(w,{disabled:this.state.disabledButtons.pageDown,className:v.PAGE_DOWN,spriteGroup:"web",spriteName:"down",tooltip:c,onClick:g(function(){return t.pageDown(u)})}):null,this.showButton("fullscreen")?s.createElement(w,{className:v.FULLSCREEN,spriteGroup:"web",spriteName:"fullscreen",tooltip:E._("Fullscreen"),onClick:g(function(){return t.toggleFullscreen(m)})}):null,this.showButton("print")?s.createElement(w,{disabled:this.state.disabledButtons.print,className:v.PRINT,spriteGroup:"web",spriteName:"print",tooltip:e,onClick:g(function(){return t.printDocument(m)})}):null,this.showButton("enable-region-creation")&&this.props.shouldDisplayRegionCreationButton?s.createElement(w,{className:v.ENABLE_REGION_CREATION,spriteGroup:"web",spriteName:"ic_comment_area_large",tooltip:E._("Comment on specific areas"),onClick:g(function(){return t.onRegionCreationClick()})}):null)))},t.prototype.sanitizePageNumber=function(e){return null==e?0:isNaN(e)?0:e},t.prototype.fadeOut=function(){this.state.fadingOut||this.clearFadeTimeout(),this.setState({fadingOut:!0,tooltipClass:void 0}),this.props.onToolbarHide&&this.props.onToolbarHide(),this.startFadeTimeout()},t.prototype.fadeIn=function(){this.clearIdleTimeout(),this.isViewerFullscreen()||this.isToolbarReadyToShow()&&(this.clearFadeTimeout(),this.setState({visible:!0,fadingOut:!1}),this.props.onToolbarShow&&this.props.onToolbarShow())},t.prototype.isAnnotationBubbleShown=function(){return i(".annotation-bubble-container .bubble-dropdown").length>0},t.prototype.startFadeTimeout=function(){var e=this;this.fadeTimeout=setTimeout(function(){e.fadeTimeout=void 0,e.setState({visible:!1,fadingOut:!1})},400)},t.prototype.clearFadeTimeout=function(){this.fadeTimeout&&(clearTimeout(this.fadeTimeout),this.fadeTimeout=void 0)},t.prototype.onIdleTimeout=function(){this.clearIdleTimeout(),this.fadeOut()},t.prototype.startIdleTimeout=function(){this.clearIdleTimeout(),this.idleTimeout=setTimeout(this.onIdleTimeout.bind(this),1500)},t.prototype.clearIdleTimeout=function(){null!=this.idleTimeout&&(clearTimeout(this.idleTimeout),this.idleTimeout=void 0)},t.prototype.clearAllTimeouts=function(){this.clearFadeTimeout(),this.clearIdleTimeout()},t.prototype.isToolbarReadyToShow=function(){return!!this.state.currentPage&&!!this.props.pagesCount},t.prototype.logData=function(e,t){return"string"==typeof t.input_method?a.PreviewActivityLogger.log(e,t):T.assert(!1,"logData not correctly formed"),"string"==typeof t.input_method},t.prototype.logUserAction=function(e,t){c.logUserAction(e,t)},t.prototype.logAndPostMessage=function(e,t,o){this.logData(t,o)&&this.frameMessenger.postMessageToChildren(e)},t.prototype.zoomIn=function(e){this.frameMessenger.postMessageToChildren(S.ZOOM_IN),this.logUserAction(d.UserAction.ZoomIn,e.context)},t.prototype.zoomOut=function(e){this.frameMessenger.postMessageToChildren(S.ZOOM_OUT),this.logUserAction(d.UserAction.ZoomOut,e.context)},t.prototype.toggleFullscreen=function(e){this.isViewerFullscreen()?this.exitFullscreen(e):this.enterFullscreen(e)},t.prototype.enterFullscreen=function(e){this.setFullScreen(!0,e)},t.prototype.exitFullscreen=function(e){this.setFullScreen(!1,e)},t.prototype.exitPreview=function(e){if(this.logData("exit-preview",e))return"function"==typeof this.props.afterFileViewerExit?this.props.afterFileViewerExit():void 0},t.prototype.printDocument=function(e){this.frameMessenger.postMessageToChildren(S.PRINT,{context:e.context})},t.prototype.searchInline=function(e){this.logUserAction(d.UserAction.InlineSearch,e.context)},t.prototype.onRegionCreationClick=function(){this.props.onRegionCreationClick&&this.props.onRegionCreationClick()},t.defaultProps={docType:d.DocType.default},t})(s.Component);t._PreviewToolbar=A;var U=p.requireCssWithComponent(A,["/static/css/preview_toolbar-vflQwB7-k.css"]);t.PreviewToolbar=U,t.PageIndicator=K});
//# sourceMappingURL=preview_toolbar.min.js-vflh7bD0e.map